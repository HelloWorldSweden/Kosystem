@page "/"
@inject NavigationManager NavigationManager
@inject IPersonSession PersonSession
@inject IRoomRepository RoomRepository

<h1>Börja köa efter hjälp</h1>

<EditForm Model="model" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />

    <input class="alert-state" id="unknown-room-alert" type="checkbox" @bind="hideRoomUnkownAlert" />
    <div class="alert alert-danger dismissible">
        Rum #@unknownRoomId.ToString("0000") finns inte.
        <label class="btn-close" for="unknown-room-alert">X</label>
    </div>

    <div class="row">
        <div class="col sm-4">
            <div class="form-group">
                <label for="roomNumber">Rumsnumret</label>
                <InputNumber class="input-block border-2" id="roomNumber" placeholder="0000" @bind-Value="model.RoomId" />
                <ValidationMessage For="() => model.RoomId" />
            </div>
        </div>
        <div class="col sm-8">
            <div class="form-group">
                <label for="name">Ditt namn</label>
                <InputText class="input-block border-3" type="text" id="name" @bind-Value="model.Name" />
                <ValidationMessage For="() => model.Name" />
            </div>
        </div>
    </div>

    <div class="row flex-center">
        <div class="sm-4 col">
            <button class="btn-large border-4" type="submit">Gå med rum</button>
        </div>
    </div>
</EditForm>

@code {
    private readonly JoinRoomViewModel model = new JoinRoomViewModel();

    private int unknownRoomId;
    private bool hideRoomUnkownAlert = true;

    void HandleValidSubmit()
    {
        if (model.RoomId is null || model.Name is null)
        {
            return;
        }

        var room = RoomRepository.FindRoom(model.RoomId.Value);
        if (!room.HasValue)
        {
            unknownRoomId = model.RoomId.Value;
            hideRoomUnkownAlert = false;
            return;
        }

        var person = PersonSession.SetCurrentPerson(model.Name);
        var success = RoomRepository.AddPersonToRoom(room.Value.Id, person.Id);

        if (!success)
        {
            unknownRoomId = model.RoomId.Value;
            hideRoomUnkownAlert = false;
        }

        NavigationManager.NavigateTo($"/{model.RoomId}");
    }
}
