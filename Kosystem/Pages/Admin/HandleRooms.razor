@page "/admin"
@attribute [Authorize]
@inject IRoomRepository RoomRepository

<h1>Hantera rum</h1>

<EditForm Model="createRoomModel" OnValidSubmit="HandleValidCreateRoomSubmit">
    <DataAnnotationsValidator />

    <input class="alert-state" id="room-created-alert" type="checkbox" @bind="hideCreatedRoomDialog" />
    <div class="alert alert-success background-success dismissible">
        <div>
            <h3>Rum <span class="badge success">#@createdRoom.Id.ToString("0000") @createdRoom.Name</span> har skapats!</h3>
            <p><a href="/@createdRoom.Id">Gå till rum #@createdRoom.Id.ToString("0000")</a></p>
        </div>
        <label class="btn-close" for="room-created-alert">X</label>
    </div>

    <div class="row flex-bottom">
        <div class="col sm-8">
            <div class="form-group">
                <label for="roomName">Rumsnamn</label>
                <InputText class="input-block border-3" type="text" id="roomName" @bind-Value="createRoomModel.Name" />
                <ValidationMessage For="() => createRoomModel.Name" />
            </div>
        </div>
        <div class="sm-4 col">
            <button class="border-5" type="submit" style="margin-bottom: 0.8rem">Skapa nytt rum</button>
        </div>
    </div>
</EditForm>

<h2>Existerande rum</h2>

<table>
    <thead>
        <tr>
            <th>Rumsnummer</th>
            <th>Rumsnamn</th>
            <th>Handling</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var room in rooms.OrderBy(o => o.Name).ThenBy(o => o.Id))
        {
            <tr>
                <td>#@room.Id.ToString("0000")</td>
                <td>@room.Name</td>
                <td><a href="/@room.Id" target="_blank"><img src="~/img/external-link.svg" title="Öppna rum i ny flik" alt="Öppna rum"/></a></td>
            </tr>
        }
    </tbody>
</table>

@code {

    private CreateRoomViewModel createRoomModel = new CreateRoomViewModel();

    private bool hideCreatedRoomDialog = true;

    private RoomModel createdRoom;

    private IReadOnlyCollection<RoomModel> rooms = Array.Empty<RoomModel>();

    protected override void OnInitialized()
    {
        rooms = RoomRepository.FindRooms();
    }

    private void HandleValidCreateRoomSubmit()
    {
        if (createRoomModel.Name is null)
        {
            return;
        }

        createdRoom = RoomRepository.CreateRoom(new NewRoomModel(createRoomModel.Name));
        hideCreatedRoomDialog = false;
    }

}
